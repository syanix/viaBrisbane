---
import { getFoodTrucksByPage } from '../utils/foodTrucksCache';
import { createTruckSlugByTruck } from '../utils/slug';
import type { FoodTruck } from '../types/types';

const { page = 1, searchQuery = '', trucks: propTrucks, totalPages: propTotalPages } = Astro.props;

// Use provided trucks and totalPages if available, otherwise fetch them
const { trucks, totalPages } = propTrucks && propTotalPages !== undefined
    ? { trucks: propTrucks, totalPages: propTotalPages }
    : await getFoodTrucksByPage(Astro.locals.runtime.env.DB, page, searchQuery);

// Determine if pagination should be shown
const showPagination = totalPages > 1 && trucks.length > 0;
---

<section class="highlight-section food-trucks-section">
    <div class="content-box">
        <h1 class="section-heading">Food Trucks in Brisbane</h1>

        <div class="search-container">
            <input 
                type="text" 
                id="truckSearch"
                placeholder="Search by name or category..."
                value={searchQuery}
            />
        </div>

        <div class="trucks-grid">
            {trucks.length > 0 ? (
                trucks.map((truck: FoodTruck) => (
                    <a href={`/food-trucks/${createTruckSlugByTruck(truck)}`} class="truck-tile">
                        <div class="image-container">
                            <img 
                                src={truck.cover_photo || '/images/default-food-truck.jpg'} 
                                alt={`${truck.name} - ${truck.category} food truck in Brisbane`}
                                loading="lazy"
                                width="300"
                                height="200"
                            />
                        </div>
                        <h3 class="truck-name">{truck.name}</h3>
                        <p class="truck-category">{truck.category}</p>
                    </a>
                ))
            ) : (
                <p>No food trucks available at the moment.</p>
            )}
        </div>

        {showPagination && (
            <div class="pagination">
                {page > 1 && (
                    <>
                        <a 
                            href={`/food-trucks?page=1${searchQuery ? `&search=${searchQuery}` : ''}`}
                        >
                            First
                        </a>
                        <a 
                            href={`/food-trucks?page=${page - 1}${searchQuery ? `&search=${searchQuery}` : ''}`}
                        >
                            Previous
                        </a>
                    </>
                )}

                {Array.from({ length: Math.min(totalPages, 5) }, (_, i) => {
                    const pageNum = Math.max(1, Math.min(page - 2, totalPages - 4)) + i;
                    if (pageNum > totalPages || pageNum < 1) return null;
                    return (
                        <a 
                            href={`/food-trucks?page=${pageNum}${searchQuery ? `&search=${searchQuery}` : ''}`}
                            class={pageNum === page ? 'active' : ''}
                        >
                            {pageNum}
                        </a>
                    );
                })}

                {page < totalPages && (
                    <>
                        <a 
                            href={`/food-trucks?page=${page + 1}${searchQuery ? `&search=${searchQuery}` : ''}`}
                        >
                            Next
                        </a>
                        <a 
                            href={`/food-trucks?page=${totalPages}${searchQuery ? `&search=${searchQuery}` : ''}`}
                        >
                            Last
                        </a>
                    </>
                )}
            </div>
        )}
    </div>
</section>

<script>
    const searchInput = document.getElementById('truckSearch') as HTMLInputElement;
    if (searchInput) {
        let debounceTimer: ReturnType<typeof setTimeout>;
        const currentValue = searchInput.value;

        searchInput.addEventListener('input', (e) => {
            const input = e.target as HTMLInputElement;
            const currentPosition = input.selectionStart;
            
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                const searchValue = input.value;
                if (searchValue !== currentValue) {
                    const url = new URL(window.location.href);
                    if (searchValue) {
                        url.searchParams.set('search', searchValue);
                    } else {
                        url.searchParams.delete('search');
                    }
                    url.searchParams.set('page', '1');
                    window.location.href = url.toString();
                }
            }, 1000);

            input.focus();
            input.setSelectionRange(currentPosition, currentPosition);
        });
    }
</script> 