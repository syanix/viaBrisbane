---
import { getEventsWithCache } from '../utils/cache';

const { limit = 6 } = Astro.props;
const eventsData = await getEventsWithCache();
const limitedEvents = eventsData.slice(0, limit);

function createSlug(subject?: string): string {
    if (!subject) return `event-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
    return subject
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/(^-|-$)/g, '');
}
---

<!-- Events Section -->
<section id="events-section" class="highlight-section" data-events-count={limit}>
    <div class="content-box">
        <h2 class="section-heading">Upcoming Events in Brisbane</h2>
        <div id="events-container">
            {limitedEvents.length > 0 ? (
                <ul>
                    {limitedEvents.map((event) => (
                        <li>
                            <img src={event.eventimage || '/images/default-image.jpg'} alt={event.subject || 'No Title'} />
                            <div>
                                <a href={`/events/${createSlug(event.subject)}`} class="title">
                                    {event.subject || 'No Title'}
                                </a>
                                <p>Date: {event.formatteddatetime || 'No Date'}</p>
                                <p>Location: {event.location || 'No Location'}</p>
                                <p>Cost: {event.cost || 'Free'}</p>
                                <p>{event.bookings || 'No booking information available'}</p>
                                <p>
                                    {event.description?.length && event.description.length > 100
                                        ? `${event.description.slice(0, 100)}...`
                                        : event.description || 'No Description'}
                                </p>
                            </div>
                        </li>
                    ))}
                </ul>
            ) : (
                <p>No events available at the moment. Please try again later.</p>
            )}
        </div>
    </div>
</section>