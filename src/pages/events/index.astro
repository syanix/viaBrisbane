---
import Layout from '../../layouts/Layout.astro';
import Events from '../../components/events.astro';
import { getEventsByPage } from '../../utils/eventsCache';

const page = parseInt(Astro.url.searchParams.get('page') || '1');
const searchQuery = Astro.url.searchParams.get('search') || '';
const showArchive = Astro.url.searchParams.has('archive');

// Construct pagination string - include all parameters
const paginationParams = new URLSearchParams();
if (page > 1) paginationParams.set('page', page.toString());
if (searchQuery) paginationParams.set('search', searchQuery);
if (showArchive) paginationParams.set('archive', 'true');
const pagination = paginationParams.toString() ? `?${paginationParams.toString()}` : '';

// Set title and description based on whether we're showing archived events
let title, description, keywords;
if (showArchive) {
    title = "Past Events Archive - Brisbane Events History - Via Brisbane";
    description = "Browse our archive of past events in Brisbane. Explore the history of local events, festivals, markets, and more that have taken place in Brisbane City and surrounding areas.";
    keywords = "Brisbane past events, Brisbane event history, previous events Brisbane, Brisbane event archive";
} else {
    title = "Brisbane Events - What's On in Brisbane - Via Brisbane";
    description = "Discover upcoming events in Brisbane. Find local events, festivals, markets, and more happening in Brisbane City and surrounding areas.";
    keywords = "Brisbane events, what's on Brisbane, Brisbane festivals, Brisbane markets, Brisbane activities";
}

// Get totalPages from the Events component
const { totalPages } = await getEventsByPage(Astro.locals.runtime.env.DB, page, searchQuery, showArchive);
---

<Layout 
    title={title} 
    description={description} 
    keywords={keywords} 
    pagination={pagination}
    page={page}
    searchQuery={searchQuery}
    totalPages={totalPages}
>
    <main>
        <Events page={page} searchQuery={searchQuery} includeExpired={showArchive} />
    </main>
</Layout>