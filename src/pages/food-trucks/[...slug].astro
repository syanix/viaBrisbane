---
import Layout from '../../layouts/Layout.astro';
import { getFoodTruckById } from '../../utils/foodTrucksCache';
import { createTruckSlugByTruck } from '../../utils/slug';
import Breadcrumbs from '../../components/breadcrumbs.astro';

// The slug will contain the full path after /events/
const { slug = '' } = Astro.params;

// Split the path into segments
const segments = slug.split('/');

// First segment should be the event ID
const truck_id = segments[0];
const truck = await getFoodTruckById(Astro.locals.runtime.env.DB, parseInt(truck_id || '0'));

if (!truck) {
    return Astro.redirect('/404');
}

const BASE_URL = import.meta.env.PUBLIC_BASE_URL || 'https://www.viabrisbane.com';
const title = `${truck.name} - Food Trucks - Via Brisbane`;
const description = truck.bio?.slice(0, 160) || `${truck.name} food truck in Brisbane`;
const keywords = `Brisbane food trucks, ${truck.name}, ${truck.category}, food truck Brisbane`;
const truckSlug = createTruckSlugByTruck(truck);
const truckUrl = `/food-trucks/${truckSlug}`;

// Create schema for food truck
const foodTruckSchema: Record<string, any> = {
  "@context": "https://schema.org",
  "@type": "FoodEstablishment",
  "name": truck.name,
  "description": truck.bio,
  "image": truck.cover_photo || `${BASE_URL}/images/default-food-truck.jpg`,
  "url": `${BASE_URL}${truckUrl}`,
  "servesCuisine": truck.category,
  "priceRange": "$$",
  "@id": `${BASE_URL}${truckUrl}#foodtruck`,
  "address": {
    "@type": "PostalAddress",
    "addressLocality": "Brisbane",
    "addressRegion": "QLD",
    "addressCountry": "AU"
  }
};

// Add social media profiles if available
if (truck.website || truck.facebook_url || truck.instagram_handle) {
  foodTruckSchema.sameAs = [];
  
  if (truck.website) {
    foodTruckSchema.sameAs.push(truck.website);
  }
  
  if (truck.facebook_url) {
    foodTruckSchema.sameAs.push(truck.facebook_url);
  }
  
  if (truck.instagram_handle) {
    foodTruckSchema.sameAs.push(`https://instagram.com/${truck.instagram_handle}`);
  }
}
---

<Layout 
  title={title} 
  description={description} 
  keywords={keywords}
  image={truck.cover_photo || '/images/default-food-truck.jpg'}
  url={truckUrl}
  schema={foodTruckSchema}
>
    <main>
        <div class="banner-container">
            <img 
                src={truck.cover_photo || '/images/default-food-truck.jpg'} 
                alt={truck.name} 
                class="banner-image"
            />
        </div>
        
        <!-- Breadcrumbs -->
        <div class="bg-slate-100 border-b border-slate-200">
            <div class="container mx-auto px-4 py-3">
                <Breadcrumbs paths={[
                    { name: 'Food Trucks', url: '/food-trucks' },
                    { name: truck.name }
                ]} />
            </div>
        </div>
        
        <section class="highlight-section food-truck-detail">
                <div class="truck-info">
                    <div class="header">
                        <div class="title-section">
                            <h1 class="section-heading">{truck.name}</h1>
                        </div>
                        <div class="meta-info">
                            <img 
                                src={truck.avatar || '/images/default-avatar.jpg'} 
                                alt={`${truck.name} logo`} 
                                class="avatar"
                            />
                            <p class="category">{truck.category}</p>
                        </div>
                    </div>

                    <div class="social-links">
                        {truck.website && (
                            <a href={truck.website} target="_blank" rel="noopener noreferrer" class="website">
                                Website
                            </a>
                        )}
                        {truck.facebook_url && (
                            <a href={truck.facebook_url} target="_blank" rel="noopener noreferrer" class="facebook">
                                Facebook
                            </a>
                        )}
                        {truck.instagram_handle && (
                            <a href={`https://instagram.com/${truck.instagram_handle}`} target="_blank" rel="noopener noreferrer" class="instagram">
                                Instagram
                            </a>
                        )}
                    </div>

                    <div class="bio">
                        <h2>About</h2>
                        <p>{truck.bio}</p>
                    </div>

                    <div class="truck-actions">
                        <a href="/food-trucks" class="button secondary">
                            Back to Food Trucks
                        </a>
                    </div>
                </div>
        </section>
    </main>
</Layout> 